<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Campus Maps</title>
    <link rel="stylesheet" href="/pages/map/css/map.css" />
</head>

<body>
    <nav>
        <div class="container">
            <div class="nav-content">
                <h1>ğŸ—ºï¸ Campus Maps</h1>
                <div class="nav-links">
                    <a href="/index.html">Home</a>
                    <a href="t.html" class="active">Maps</a>
                </div>
            </div>
        </div>
    </nav>

    <div id="map-container">
        <div class="container">
            <canvas id="myCanvas" width="1423" height="653"></canvas>
            <div id="map-controls">
                <div class="controls-group">
                    <select id="map-select">
                        <option value="">Select Map</option>
                    </select>
                    <button id="delete-map">ğŸ—‘ï¸ Delete Map</button>
                    <div class="upload-btn-wrapper">
                        <button class="btn-upload">
                          ğŸ“¤ Upload Map
                          <input type="file" id="map-upload" accept="image/*" />
                        </button>
                      </div>
                </div>
                <div class="controls-group">
                    <input type="text" id="pointName" placeholder="Enter point name" />
                    <button id="logPoints">ğŸ“ Add Point</button>
                    <button id="resetPoints">ğŸ”„ Reset</button>
                    <button id="toggleMode">ğŸ”„ Toggle Mode</button>
                    <button id="deletePoint">ğŸ—‘ï¸ Delete Point</button>
                </div>
                <div class="controls-group">
                    <select id="pointSelect"></select>
                    <select id="point1Select"></select>
                    <select id="point2Select"></select>
                    <button id="showDistance">ğŸ“ Show Distance</button>
                </div>
                <div class="controls-group">
                    <select id="editPointSelect"></select>
                    <input type="text" id="newPointName" placeholder="Enter new point name" />
                    <button id="editPoint">âœï¸ Edit Point Name</button>
                </div>
            </div>
            <div id="modeIndicator"></div>
            <div id="distanceDisplay"></div>
        </div>
    </div>
    
    <div id="tooltip" class="tooltip"></div>
    
    <div id="map-sample-container" class="container">
        <h3>Available Maps</h3>
        <div class="map-samples">
            <img src="./2.jpg" alt="Sample Map 1" class="map-sample" data-map-src="./2.jpg">
        </div>
    </div>
    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFhkQgV566VA1QjexbaCsAJ8iCfQXpW0g",
            authDomain: "esp8266-t1-37f02.firebaseapp.com",
            databaseURL: "https://esp8266-t1-37f02-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "esp8266-t1-37f02",
            storageBucket: "esp8266-t1-37f02.appspot.com",
            messagingSenderId: "201166852539",
            appId: "1:201166852539:web:42c3ad90a0611b17d5b49e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app), dbRef = ref(db, "Data");

        const tooltip = document.getElementById("tooltip");
        // Canvas and Drawing Code
        const canvas = document.getElementById("myCanvas"), ctx = canvas.getContext("2d");
        let points = [], drawMode = true, markerCoordinates = [], maps = [];
        const img = new Image();
        const mapSamples = [
            { src: './2.jpg', name: 'Sample Map 1' }
            // { src: 'sample-map2.jpg', name: 'Sample Map 2' },
            // { src: 'sample-map3.jpg', name: 'Sample Map 3' }
        ];

        function loadMap(mapSrc) {
            img.src = mapSrc;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                if (drawMode) drawMarkers();
            };
        }

        function addSampleMap(sample) {
            maps.push(sample.src);
            updateMapSelect();
            const mapSelect = document.getElementById("map-select");
            mapSelect.value = maps.length - 1; // à¹€à¸¥à¸·à¸­à¸à¹à¸œà¸™à¸—à¸µà¹ˆà¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¹‚à¸”à¸¢à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
            loadMap(sample.src); // à¹‚à¸«à¸¥à¸”à¹à¸œà¸™à¸—à¸µà¹ˆà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸
        }

        document.querySelectorAll('.map-sample').forEach(img => {
            img.addEventListener('click', () => {
                const mapSrc = img.getAttribute('data-map-src');
                addSampleMap({ src: mapSrc, name: img.alt });
            });
        });

        // Update the map dropdown
        function updateMapSelect() {
            const mapSelect = document.getElementById("map-select");
            mapSelect.innerHTML = "<option value=''>Select Map</option>";
            maps.forEach((_, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.textContent = `Map ${index + 1}`;
                mapSelect.appendChild(option);
            });
        }

        // Load map on file upload
        document.getElementById("map-upload").addEventListener("change", event => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const mapSrc = e.target.result;
                    maps.push(mapSrc);
                    updateMapSelect();

                    // Automatically select the latest map in dropdown
                    document.getElementById("map-select").value = maps.length - 1;
                    loadMap(mapSrc);
                };
                reader.readAsDataURL(file);
            }
        });

        // Load the selected map
        document.getElementById("map-select").addEventListener("change", event => {
            const selectedIndex = event.target.value;
            if (selectedIndex) loadMap(maps[selectedIndex]);
        });

        // Delete map event

        document.getElementById("delete-map").addEventListener("click", () => {
            const mapSelect = document.getElementById("map-select");
            const selectedIndex = mapSelect.value;

            if (selectedIndex === "") {
                alert("Please select a map to delete.");
                return;
            }

            // Check if the selected index is valid
            if (selectedIndex !== null && selectedIndex >= 0) {
                maps.splice(selectedIndex, 1);  // Remove the selected map from the array
                updateMapSelect();  // Refresh the dropdown list

                ctx.clearRect(0, 0, canvas.width, canvas.height);  // Clear the canvas
                points = [];  // Reset points
                markerCoordinates = [];  // Reset marker coordinates

                // If there are still maps left, load the first one
                if (maps.length > 0) {
                    mapSelect.value = 0;  // Select the first map
                    loadMap(maps[0]);  // Load the first map
                } else {
                    // If no maps are left, clear everything
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }

                console.log(`Map ${parseInt(selectedIndex) + 1} deleted`);
            }
        });

        canvas.addEventListener("click", event => {
            const pointName = document.getElementById("pointName").value;

            // à¹€à¸à¸´à¹ˆà¸¡à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µà¹à¸œà¸™à¸—à¸µà¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
            if (maps.length === 0) {
                alert("Please upload or select a map before adding points.");
                return; // à¸«à¸¢à¸¸à¸”à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸«à¸²à¸à¹„à¸¡à¹ˆà¸¡à¸µà¹à¸œà¸™à¸—à¸µà¹ˆ
            }

            if (!validatePoint(pointName)) return;

            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left, y = event.clientY - rect.top;

            if (drawMode) addMarkerAndPoint(x, y, pointName);
            else addPoint(x, y, pointName);
        });


        canvas.addEventListener("mousemove", event => {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            const hoveredPoint = points.find(point => {
                const dx = point.x - x;
                const dy = point.y - y;
                return Math.sqrt(dx * dx + dy * dy) < 5; // Adjust the radius as needed
            });

            if (hoveredPoint) {
                tooltip.innerText = `Name: ${hoveredPoint.name}\nDistance: ${hoveredPoint.distance.toFixed(2)} m\nRSSI: ${hoveredPoint.rssi} dBm`;
                tooltip.style.display = "block";
                tooltip.style.left = `${event.pageX + 10}px`;
                tooltip.style.top = `${event.pageY + 10}px`;
            } else tooltip.style.display = "none";
        });

        function resetCanvas() {
            // à¸¥à¹‰à¸²à¸‡à¸—à¸±à¹‰à¸‡ canvas à¹à¸¥à¸°à¸¥à¸šà¸§à¸‡à¸à¸¥à¸¡à¸¥à¹‰à¸­à¸¡à¸ˆà¸¸à¸”
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            points = [];

            // à¸§à¸²à¸”à¹à¸œà¸™à¸—à¸µà¹ˆà¹ƒà¸«à¸¡à¹ˆ (à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡)
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸à¸²à¸£à¸Ÿà¸±à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Firebase (à¸–à¹‰à¸²à¸¡à¸µ)
            resetFirebaseDataListeners();

            console.log("Canvas, points, and circles reset");
        }

        function resetFirebaseDataListeners() {
            // à¸–à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¢à¸à¹€à¸¥à¸´à¸à¸à¸²à¸£à¸Ÿà¸±à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Firebase à¹ƒà¸™à¸•à¸­à¸™ reset
            off(dbRef); // à¸¢à¸à¹€à¸¥à¸´à¸à¸à¸²à¸£à¸Ÿà¸±à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
            console.log("Firebase data listeners reset");
        }

        function drawMarkers() {
            ctx.save();
            ctx.fillStyle = "blue";
            markerCoordinates.forEach(marker => drawMarker(marker.x, marker.y));
            ctx.restore();
        }

        function drawMarker(x, y) {
            ctx.fillStyle = "blue";
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
        }

        function drawPoint(x, y, name, color = "black") {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillStyle = "black";
            ctx.fillText(`${name} (${Math.round(x)}, ${Math.round(y)})`, x + 5, y - 5);
        }

        function validatePoint(pointName) {
            if (!pointName) {
                alert("Please enter a name for the point.");
                return false;
            }

            if (points.some(point => point.name === pointName)) {
                alert("Point name must be unique.");
                return false;
            }

            return true;
        }

        function addMarkerAndPoint(x, y, name) {
            markerCoordinates.push({ x, y });
            drawMarker(x, y);
            addPoint(x, y, name);
        }

        function addPoint(x, y, name) {
            const color = drawMode ? "blue" : "red";
            drawPoint(x, y, name, color);
            const distance = 0;
            const rssi = "Not available";
            points.push({ x, y, name, color, distance, rssi });
            console.log(`Point added: ${name} at (${x}, ${y})`);
            checkAndDisplayPointData({ x, y, name });
            updatePointSelects();
        }

        function logPoints() {
            points.forEach((point, index) =>
                console.log(`Point ${index + 1}: (${Math.round(point.x)}, ${Math.round(point.y)}) - Name: ${point.name}`)
            );
            exportToCSV();
        }

        function toggleMode() {
            drawMode = !drawMode;
            updateModeIndicator();
        }

        function showDistance() {
            const index1 = document.getElementById("point1Select").value;
            const index2 = document.getElementById("point2Select").value;

            if (index1 === index2) {
                alert("Cannot measure distance between the same point.");
                return;
            }

            if (index1 && index2) {
                const distance = calculateDistance(points[index1], points[index2]);
                document.getElementById("distanceDisplay").innerText = `Distance between ${points[index1].name} and ${points[index2].name}: ${distance.toFixed(2)} meters`;
            }
        }

        function deletePoint() {
            const selectedIndex = document.getElementById("pointSelect").value;
            if (!selectedIndex) {
                alert("Please select a point to delete.");
                return;
            }

            points.splice(selectedIndex, 1);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            points.forEach(point => {
                drawPoint(point.x, point.y, point.name, point.color);
                if (point.distance > 0) drawCircle(point.x, point.y, point.distance);
            });

            updatePointSelects();
            console.log("Points after deletion:", points);
        }

        function editPointName() {
            const selectedIndex = document.getElementById("editPointSelect").value;
            const newPointName = document.getElementById("newPointName").value;

            if (!selectedIndex) {
                alert("Please select a point to edit.");
                return;
            }

            if (!newPointName) {
                alert("Please enter a new name for the point.");
                return;
            }

            if (points.some(point => point.name === newPointName)) {
                alert("Point name must be unique.");
                return;
            }

            // à¸­à¸±à¸›à¹€à¸”à¸•à¸Šà¸·à¹ˆà¸­à¸ˆà¸¸à¸”à¹ƒà¸™ array à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸µ
            points[selectedIndex].name = newPointName;

            // à¸£à¸µà¹€à¸‹à¹‡à¸• canvas à¹€à¸à¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¸Šà¸·à¹ˆà¸­à¸ˆà¸¸à¸”à¹ƒà¸«à¸¡à¹ˆ à¹‚à¸”à¸¢à¸¢à¸±à¸‡à¸„à¸‡à¸ªà¸µà¹€à¸”à¸´à¸¡à¹„à¸§à¹‰
            resetCanvas();
            updatePointSelects();
            document.getElementById("newPointName").value = "";
            console.log("Points after editing:", points);
        }

        function updateModeIndicator() {
            const modeIndicator = document.getElementById("modeIndicator");
            modeIndicator.textContent = drawMode ? "Mode: Adding Routers" : "Mode: Adding Points";
        }

        function updatePointSelects() {
            const selects = [document.getElementById("point1Select"), document.getElementById("point2Select"), document.getElementById("pointSelect"), document.getElementById("editPointSelect")];
            selects.forEach(select => {
                select.innerHTML = "";
                points.forEach((point, index) => {
                    const option = document.createElement("option");
                    option.value = index;
                    option.textContent = point.name;
                    select.appendChild(option);
                });
            });
        }

        function fetchPointData(pointName) {
            const pointRef = ref(db, 'points/' + pointName);
            return get(pointRef).then(snapshot => snapshot.val());
        }

        function drawCircle(x, y, distance) {
            console.log(`Drawing circle at (${x}, ${y}) with radius: ${distance * 100}`);
            ctx.beginPath();
            // ctx.arc(x, y, distance * 100, 0, 2 * Math.PI);  // Scale distance by 100
            ctx.arc(x, y, distance * 90, 0, 2 * Math.PI);  // Scale distance by 100
            ctx.strokeStyle = 'rgba(0, 0, 255, 0.5)';
            ctx.stroke();

        }

        function checkAndDisplayPointData(point) {
            if (point.name === "TP-Link_2536_1" || point.name === "TP-Link_2536_2") {
                const routerKey = point.name === "TP-Link_2536_1" ? "Router1" : "Router2";

                onValue(dbRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const RSSI = data[routerKey]?.rssi ?? "Not available";
                        const Distance = data[routerKey]?.Log?.distance ?? "Not available";

                        // à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸°à¸¢à¸°à¸—à¸²à¸‡à¹à¸¥à¸° RSSI
                        const foundPoint = points.find(p => p.name === point.name);
                        if (foundPoint) foundPoint.distance = Distance; foundPoint.rssi = RSSI;

                        if (drawMode) {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            points.forEach(point => {
                                drawPoint(point.x, point.y, point.name, point.color);
                                if (point.distance > 0) drawCircle(point.x, point.y, point.distance);  // à¸§à¸²à¸”à¸§à¸‡à¸à¸¥à¸¡à¸—à¸µà¹ˆà¸¡à¸µà¸„à¹ˆà¸² distance

                            });
                        }

                        console.log(`RSSI: ${RSSI} dBm\nDistance: ${Distance.toFixed(5)} m`);
                    } else {
                        console.log("No data available");
                    }
                }, (error) => {
                    console.error("Error reading data: ", error);
                });
            } else {
                console.log(`Point ${point.name} does not match any TP-Link routers`);
            }
        }

        document.getElementById("resetPoints").addEventListener("click", resetCanvas);
        document.getElementById("logPoints").addEventListener("click", logPoints);
        document.getElementById("toggleMode").addEventListener("click", toggleMode);
        document.getElementById("showDistance").addEventListener("click", showDistance);
        document.getElementById("deletePoint").addEventListener("click", deletePoint);
        document.getElementById("editPoint").addEventListener("click", editPointName);
        updateModeIndicator();
    </script>

</body>

</html>